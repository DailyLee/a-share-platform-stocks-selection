# 扫描日期数据范围说明

## 答案：是的，扫描日期包含当天的数据

## 详细说明

### 1. 数据库查询逻辑

在 `api/stock_database.py` 的 `get_kline_data` 方法中：

```python
query = '''
    SELECT date, open, high, low, close, volume, turn, 
           preclose, pctChg, peTTM, pbMRQ
    FROM kline_data
    WHERE code = ? AND date >= ? AND date <= ?
    ORDER BY date ASC
'''
```

**关键点**：查询条件使用 `date <= end_date`，这意味着**包含 end_date 当天的数据**。

### 2. Baostock API 行为

在 `api/data_fetcher.py` 中，`end_date` 参数被直接传递给 Baostock API：

```python
bs.query_history_k_data_plus(
    code,
    "date,open,high,low,close,volume,turn,preclose,pctChg,peTTM,pbMRQ",
    start_date=start_date,
    end_date=end_date,  # 包含 end_date 当天的数据
    frequency="d",
    adjustflag="2"
)
```

**Baostock API 的 `end_date` 参数是包含的（inclusive）**，即会返回 end_date 当天的数据。

### 3. 数据完整性检查

在 `fetch_kline_data` 函数中，有数据完整性检查：

```python
need_later = (end_dt - max_date).days > 1
```

这个检查的逻辑是：
- 如果数据库中已有数据的最大日期（max_date）小于 end_date **超过1天**，才会去获取更多数据
- 如果 max_date 等于或接近 end_date（在1天范围内），就不会再获取数据
- 这说明 **end_date 是包含的**，因为如果 max_date 等于 end_date，就认为数据已经完整了

### 4. 实际场景说明

#### 场景1：扫描日期是今天（交易日）

- **设置**：扫描日期 = 2024-01-15（今天是交易日）
- **结果**：会包含 2024-01-15 当天的K线数据
- **数据范围**：从 `start_date` 到 `2024-01-15`（包含）

#### 场景2：扫描日期是今天（非交易日，如周末）

- **设置**：扫描日期 = 2024-01-14（假设是周六）
- **结果**：会尝试获取 2024-01-14 的数据，但由于是周末，实际返回的数据最大日期可能是 2024-01-12（周五）
- **数据范围**：从 `start_date` 到最近一个交易日的数据

#### 场景3：扫描日期是过去的某个日期

- **设置**：扫描日期 = 2024-01-10（过去的交易日）
- **结果**：会包含 2024-01-10 当天的K线数据
- **数据范围**：从 `start_date` 到 2024-01-10（包含）

#### 场景4：扫描日期是过去的某个非交易日

- **设置**：扫描日期 = 2024-01-07（假设是周日）
- **结果**：会尝试获取 2024-01-07 的数据，但由于是周末，实际返回的数据最大日期可能是 2024-01-05（周五）
- **数据范围**：从 `start_date` 到最近一个交易日的数据

## 重要提示

1. **交易日 vs 自然日**：
   - 扫描日期是自然日（YYYY-MM-DD格式）
   - 如果该日期是交易日，会包含当天的数据
   - 如果该日期是非交易日（周末、节假日），会包含最近一个交易日的数据

2. **数据可用性**：
   - 如果扫描日期是今天，且今天是交易日，数据可能还在更新中（盘中数据）
   - 如果扫描日期是今天，且今天是交易日收盘后，会包含完整的当天数据
   - 如果扫描日期是过去的日期，数据应该是完整的

3. **数据范围计算**：
   ```python
   # 在 platform_scanner.py 中
   end_date = "2024-01-15"  # 扫描日期
   start_date = (end_date_obj - timedelta(days=max_window * 2)).strftime('%Y-%m-%d')
   # 例如：如果 max_window = 120，start_date 大约是 2023-09-17
   # 数据范围：2023-09-17 到 2024-01-15（包含）
   ```

## 验证方法

可以通过以下方式验证：

1. **查看日志**：
   ```bash
   sudo journalctl -u stock-scanner -f | grep "Date range"
   ```
   会显示类似：
   ```
   Date range: 2023-09-17 to 2024-01-15
   ```

2. **检查返回的数据**：
   - 扫描结果中的 `kline_data` 字段
   - 检查最后一条数据的日期是否等于或接近扫描日期

3. **单股检查**：
   - 使用单股检查功能，设置扫描日期
   - 查看K线图，确认是否包含扫描日期当天的数据

## 总结

✅ **扫描日期包含当天的数据**（如果当天是交易日）

✅ 数据库查询使用 `date <= end_date`，确保包含 end_date

✅ Baostock API 的 end_date 参数是包含的（inclusive）

⚠️ 如果扫描日期是非交易日，会包含最近一个交易日的数据

