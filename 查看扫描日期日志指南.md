# 查看后端日志检查扫描日期使用情况

## 方法一：使用 systemd journalctl（推荐）

如果后端服务是通过 systemd 运行的（使用 `stock-scanner.service`），日志会输出到 systemd journal。

### 1. 查看实时日志（推荐）

```bash
# 实时查看所有日志
sudo journalctl -u stock-scanner -f

# 实时查看最近100行日志
sudo journalctl -u stock-scanner -f -n 100
```

### 2. 查看最近的日志

```bash
# 查看最近50行日志
sudo journalctl -u stock-scanner -n 50

# 查看最近1小时的日志
sudo journalctl -u stock-scanner --since "1 hour ago"

# 查看今天的日志
sudo journalctl -u stock-scanner --since today
```

### 3. 搜索包含扫描日期的日志

```bash
# 搜索包含 "scan_date" 的日志
sudo journalctl -u stock-scanner | grep -i "scan_date"

# 搜索包含 "截止日期" 的日志
sudo journalctl -u stock-scanner | grep "截止日期"

# 搜索包含 "Date range" 的日志
sudo journalctl -u stock-scanner | grep "Date range"
```

## 方法二：直接查看进程输出

如果后端是直接运行的（不是通过 systemd），日志会直接输出到终端。

### 查看运行中的进程

```bash
# 查找 Python 进程
ps aux | grep uvicorn

# 或者查找包含 index:app 的进程
ps aux | grep "index:app"
```

## 关键日志信息

执行扫描时，后端会输出以下关键日志，可以用来验证扫描日期：

### 1. 扫描开始时的日志

```
[INDEX] Starting scan_stocks with X stocks, scan_date=YYYY-MM-DD
```

**示例：**
```
[INDEX] Starting scan_stocks with 5500 stocks, scan_date=2024-01-15
```

### 2. 扫描参数日志（在 platform_scanner.py 中）

```
======================================
[SCAN_CHECKPOINT] Starting stock platform scan
======================================
Scan parameters:
  - Date range: YYYY-MM-DD to YYYY-MM-DD
```

**示例：**
```
Scan parameters:
  - Date range: 2023-07-01 to 2024-01-15
```

这里的 `end_date`（第二个日期）应该等于你设置的扫描日期。

### 3. 缓存相关日志

```
找到缓存结果: 截止日期=YYYY-MM-DD, 扫描配置已缓存
```

**示例：**
```
找到缓存结果: 截止日期=2024-01-15, 扫描配置已缓存
```

## 验证步骤

1. **设置扫描日期**：在前端界面选择一个特定的日期（例如：2024-01-15）

2. **开始扫描**：点击"开始扫描"按钮

3. **查看日志**：使用以下命令实时查看日志：
   ```bash
   sudo journalctl -u stock-scanner -f | grep -E "scan_date|截止日期|Date range"
   ```

4. **验证日志输出**：应该看到类似以下的输出：
   ```
   [INDEX] Starting scan_stocks with 5500 stocks, scan_date=2024-01-15
   找到缓存结果: 截止日期=2024-01-15, 扫描配置已缓存
   ```
   或者如果没有缓存：
   ```
   [INDEX] Starting scan_stocks with 5500 stocks, scan_date=2024-01-15
   Scan parameters:
     - Date range: 2023-07-01 to 2024-01-15
   ```

5. **确认日期正确**：检查日志中的日期是否与你设置的扫描日期一致

## 常见问题排查

### 问题1：看不到日志

**解决方案：**
- 确认服务正在运行：`sudo systemctl status stock-scanner`
- 确认服务名称正确：`sudo systemctl list-units | grep stock`

### 问题2：日志中没有 scan_date

**可能原因：**
- 前端没有发送 scan_date 参数
- 后端代码版本不是最新的

**检查方法：**
```bash
# 查看最近的请求日志
sudo journalctl -u stock-scanner -n 200 | grep -A 5 "POST /api/scan"
```

### 问题3：日期格式不正确

**检查方法：**
```bash
# 查看所有包含日期的日志
sudo journalctl -u stock-scanner | grep -E "2024-|2023-|2025-"
```

## 快速检查脚本

创建一个快速检查脚本 `check_scan_date.sh`：

```bash
#!/bin/bash
echo "=== 检查最近的扫描日期日志 ==="
echo ""
echo "1. 最近的 scan_date 日志："
sudo journalctl -u stock-scanner -n 100 | grep -i "scan_date" | tail -5
echo ""
echo "2. 最近的日期范围日志："
sudo journalctl -u stock-scanner -n 100 | grep "Date range" | tail -5
echo ""
echo "3. 最近的缓存日志："
sudo journalctl -u stock-scanner -n 100 | grep "截止日期" | tail -5
```

使用方法：
```bash
chmod +x check_scan_date.sh
./check_scan_date.sh
```

## 注意事项

1. **日志权限**：如果使用 systemd，可能需要 sudo 权限查看日志
2. **日志轮转**：systemd journal 默认会保留一定时间的日志，旧日志可能已被清理
3. **时区问题**：确保服务器时区设置正确，日期显示可能受时区影响
4. **缓存影响**：如果使用了缓存，可能不会看到完整的扫描日志，只会看到缓存命中的日志

