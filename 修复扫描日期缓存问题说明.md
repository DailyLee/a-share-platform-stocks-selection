# 修复扫描日期缓存问题说明

## 问题描述

不同日期的扫描都命中了同一个缓存，导致扫描结果不正确。

## 问题原因

1. **缓存键生成问题**：`config_dict` 中包含了 `scan_date` 字段（可能是 `None`），但实际使用的 `scan_date` 可能是当前日期
2. **重复包含**：`scan_date` 既在 `config_dict` 中被序列化，又作为单独参数传入缓存键生成函数
3. **不一致性**：如果前端发送的 `scan_date` 是 `None`，`config_dict` 中会有 `scan_date: null`，但实际使用的 `scan_date` 是当前日期

## 修复方案

### 1. 在生成缓存键前移除 `scan_date`

在调用 `generate_scan_cache_key` 之前，从 `config_dict` 中移除 `scan_date`：

```python
# 生成缓存键：从 config_dict 中移除 scan_date，避免重复
cache_config_dict = config_dict.copy()
cache_config_dict.pop('scan_date', None)  # 移除 scan_date，避免影响缓存键
cache_key = generate_scan_cache_key(cache_config_dict, scan_date)
```

### 2. 在缓存键生成函数中也确保移除

在 `generate_scan_cache_key` 函数中，确保 `scan_date` 不会出现在配置字典中：

```python
def generate_scan_cache_key(scan_config: Dict[str, Any], backtest_date: str) -> str:
    # Ensure scan_date is not in config_dict (it's passed separately)
    clean_config = {k: v for k, v in scan_config.items() if k != 'scan_date'}
    # ... 生成缓存键
```

### 3. 添加调试日志

添加日志来帮助验证缓存键是否正确生成：

```python
print(f"{Fore.CYAN}[CACHE_KEY] Generated cache key: {cache_key[:16]}... (scan_date={backtest_date}){Style.RESET_ALL}")
```

## 验证步骤

### 1. 清除旧缓存（重要！）

由于旧的缓存键可能不正确，需要清除旧的缓存：

```bash
# 如果后端提供了清除缓存的API，可以使用
# 或者直接删除数据库中的缓存表
```

### 2. 测试不同日期的扫描

1. **第一次扫描**：设置扫描日期为 `2024-01-15`
   - 应该不会命中缓存（首次扫描）
   - 查看日志，确认缓存键生成

2. **第二次扫描**：设置扫描日期为 `2024-01-16`
   - 应该不会命中缓存（不同日期）
   - 查看日志，确认缓存键不同

3. **第三次扫描**：再次设置扫描日期为 `2024-01-15`
   - 应该命中缓存（相同日期和配置）
   - 查看日志，确认缓存键与第一次相同

### 3. 查看日志验证

运行以下命令查看日志：

```bash
# 实时查看日志
sudo journalctl -u stock-scanner -f | grep -E "scan_date|CACHE_KEY|缓存键"

# 查看最近的日志
sudo journalctl -u stock-scanner -n 100 | grep -E "scan_date|CACHE_KEY|缓存键"
```

### 4. 预期的日志输出

**第一次扫描（2024-01-15）：**
```
[INDEX] ✓ 使用配置的扫描日期: 2024-01-15
[CACHE_KEY] Generated cache key: abc123def456... (scan_date=2024-01-15)
[INDEX] 缓存键生成: scan_date=2024-01-15, cache_key=abc123def456...
```

**第二次扫描（2024-01-16）：**
```
[INDEX] ✓ 使用配置的扫描日期: 2024-01-16
[CACHE_KEY] Generated cache key: xyz789uvw012... (scan_date=2024-01-16)
[INDEX] 缓存键生成: scan_date=2024-01-16, cache_key=xyz789uvw012...
```

**第三次扫描（2024-01-15，应该命中缓存）：**
```
[INDEX] ✓ 使用配置的扫描日期: 2024-01-15
[CACHE_KEY] Generated cache key: abc123def456... (scan_date=2024-01-15)
[INDEX] 缓存键生成: scan_date=2024-01-15, cache_key=abc123def456...
找到缓存结果: 截止日期=2024-01-15, 扫描配置已缓存
```

## 注意事项

1. **清除旧缓存**：修复后，旧的缓存可能使用了错误的缓存键，建议清除所有旧缓存
2. **日志验证**：确保日志中显示的 `scan_date` 与你设置的日期一致
3. **缓存键一致性**：相同日期和配置应该生成相同的缓存键

## 如何清除缓存

如果后端提供了清除缓存的API，可以使用：

```bash
# 清除所有扫描缓存
curl -X DELETE http://your-server/api/cache/scan

# 或者通过数据库直接删除
# 连接到数据库，执行：
# DELETE FROM scan_cache;
```

## 修复的文件

- `api/index.py`：
  - 修复了 `/api/scan/start` 端点的缓存键生成
  - 修复了 `/api/scan` 端点的缓存键生成
  - 增强了 `generate_scan_cache_key` 函数，确保移除 `scan_date`

